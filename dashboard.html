<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sajku1 Dashboard - Final Updated</title>

  <!-- Firebase Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
    import { getDatabase, ref as dbRef, set as dbSet, onValue } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCO6p2DX7cb19ELNHbsDl0ZRQ7kgMvUzGs",
      authDomain: "sajku-store.firebaseapp.com",
      projectId: "sajku-store",
      storageBucket: "sajku-store.appspot.com",
      messagingSenderId: "831227140840",
      appId: "1:831227140840:web:634cc6248ead6ab186075d",
      measurementId: "G-BDH8FP9R56",
      databaseURL: "https://sajku-store-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();
    const rtdb = getDatabase();
    const storage = getStorage();

    let systemPassword = "";
    let passwordAttempts = 0;
    let systemBlocked = false;

    async function getSystemPassword() {
      const passDoc = await getDoc(doc(db, "admin", "password"));
      if (passDoc.exists()) {
        systemPassword = passDoc.data().pass;
      }
    }
    getSystemPassword();

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        document.getElementById('userName').innerText = user.displayName || "No Name";
        document.getElementById('userPhoto').src = user.photoURL || "https://via.placeholder.com/150";
        fetchEarnings(user.uid);
        fetchUploads(user.uid);
      } else {
        window.location.href = "login.html";
      }
    });

    window.updateProfileData = async () => {
      const name = document.getElementById('nameInput').value;
      const photo = document.getElementById('photoInput').files[0];
      const user = auth.currentUser;
      if (!user) return alert("User Not Found!");

      if (photo) {
        const photoRef = storageRef(storage, `profilePics/${user.uid}`);
        await uploadBytes(photoRef, photo);
        const photoURL = await getDownloadURL(photoRef);
        await updateProfile(user, { displayName: name, photoURL });
        await updateDoc(doc(db, "users", user.uid), { name, photoURL });
        document.getElementById('userName').innerText = name;
        document.getElementById('userPhoto').src = photoURL;
      } else {
        await updateProfile(user, { displayName: name });
        await updateDoc(doc(db, "users", user.uid), { name });
        document.getElementById('userName').innerText = name;
      }
      alert("Profile Updated Successfully!");
    };

    window.uploadApp = async () => {
      const appName = document.getElementById('appName').value.trim();
      const description = document.getElementById('appDesc').value.trim();
      const screenshots = document.getElementById('appScreenshots').files;
      const video = document.getElementById('appVideo').files[0];
      const apk = document.getElementById('appApk').files[0];
      const user = auth.currentUser;

      if (!user || !appName || !description || screenshots.length === 0 || !apk) {
        return alert("Please fill all required fields.");
      }

      const bannerAd = document.getElementById('bannerAd').value || "ca-app-pub-5534254536913287/6837788351";
      const interstitialAd = document.getElementById('interstitialAd').value || "ca-app-pub-5534254536913287/6044824702";
      const rewardedAd = document.getElementById('rewardedAd').value || "ca-app-pub-5534254536913287/7212596405";
      const nativeAd = document.getElementById('nativeAd').value || "ca-app-pub-5534254536913287/3273351397";
      const appOpenAd = document.getElementById('appOpenAd').value || "ca-app-pub-5534254536913287/7021024718";

      const appDoc = await addDoc(collection(db, "apps"), {
        uploader: user.uid,
        appName,
        description,
        admob: { banner: bannerAd, interstitial: interstitialAd, rewarded: rewardedAd, native: nativeAd, appOpen: appOpenAd },
        createdAt: new Date(),
        approved: false
      });

      const uploads = [];
      for (let i = 0; i < screenshots.length; i++) {
        const sRef = storageRef(storage, `apps/${appDoc.id}/screenshot${i}.jpg`);
        uploads.push(uploadBytes(sRef, screenshots[i]));
      }

      if (video) {
        const vRef = storageRef(storage, `apps/${appDoc.id}/video.mp4`);
        uploads.push(uploadBytes(vRef, video));
      }

      const apkRef = storageRef(storage, `apps/${appDoc.id}/app.apk`);
      uploads.push(uploadBytes(apkRef, apk));

      await Promise.all(uploads);
      alert("App Uploaded Successfully! Waiting for Admin Approval.");
    };

    let userEarnings = { uploader: 0, downloader: 0 };
    async function fetchEarnings(uid) {
      onValue(dbRef(rtdb, `earnings/${uid}`), (snapshot) => {
        const data = snapshot.val() || { uploader: 0, downloader: 0 };
        userEarnings = data;
        document.getElementById('uploaderEarning').innerText = `${data.uploader} ₹`;
        document.getElementById('downloaderEarning').innerText = `${data.downloader} ₹`;
      });
    }

    async function fetchUploads(uid) {
      onSnapshot(collection(db, "apps"), (snapshot) => {
        const uploads = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.uploader === uid) {
            uploads.push(`<li>${data.appName} - <button onclick="openApp('${doc.id}')">Open</button></li>`);
          }
        });
        document.getElementById('uploadedApps').innerHTML = uploads.join("") || "No Apps Uploaded.";
      });
    }

    window.openApp = (id) => {
      window.location.href = `view-app.html?id=${id}`;
    };

    window.logout = () => {
      signOut(auth);
    };

    window.requestWithdraw = async () => {
      const amount = Number(document.getElementById('withdrawAmount').value);
      const bankName = document.getElementById('bankName').value.trim();
      const accountNumber = document.getElementById('accountNumber').value.trim();
      const ifscCode = document.getElementById('ifscCode').value.trim();
      const proofPhoto = document.getElementById('proofPhoto').files[0];
      const user = auth.currentUser;
      if (!user || amount <= 0 || !bankName || !accountNumber || !ifscCode || !proofPhoto) {
        return alert("Please fill all fields and upload proof photo.");
      }

      const totalEarning = userEarnings.uploader + userEarnings.downloader;
      if (amount > totalEarning) {
        return alert("Insufficient Balance!");
      }

      const proofRef = storageRef(storage, `withdrawProofs/${user.uid}_${Date.now()}.jpg`);
      await uploadBytes(proofRef, proofPhoto);
      const proofURL = await getDownloadURL(proofRef);

      await addDoc(collection(db, "withdraws"), {
        userId: user.uid,
        amount,
        bankName,
        accountNumber,
        ifscCode,
        proofPhotoURL: proofURL,
        requestedAt: new Date()
      });

      alert("Withdraw Request Submitted Successfully with Proof!");
    };

    window.changePassword = async () => {
      if (systemBlocked) {
        return alert("System permanently blocked due to wrong password attempts.");
      }
      const enteredPassword = prompt("Enter System Password:");
      if (enteredPassword !== systemPassword) {
        passwordAttempts++;
        if (passwordAttempts >= 3) {
          systemBlocked = true;
          alert("System permanently blocked!");
        } else {
          alert("Wrong Password! Attempts left: " + (3 - passwordAttempts));
        }
        return;
      }
      const newPassword = document.getElementById('newPassword').value.trim();
      if (!newPassword) return alert("Please enter a new password.");
      await setDoc(doc(db, "admin", "password"), { pass: newPassword });
      systemPassword = newPassword;
      passwordAttempts = 0;
      alert("Password Changed Successfully!");
    };
  </script>

  <style>
    body {
      background: linear-gradient(135deg, #2193b0, #6dd5ed);
      font-family: 'Arial', sans-serif;
      color: #fff;
      margin: 0;
      padding: 20px;
    }
    .dashboard {
      max-width: 900px;
      margin: auto;
    }
    .box {
      background: white;
      color: black;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    h2 { color: #2193b0; }
    input, textarea, button {
      width: 100%;
      margin-top: 10px;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
    }
    button {
      background: #2193b0;
      color: white;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background: #6dd5ed;
    }
    .profile-img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 50%;
      margin-bottom: 15px;
    }
    ul { list-style-type: none; padding: 0; }
    .warning {
      background-color: red;
      color: white;
      padding: 10px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 20px;
      font-weight: bold;
    }
  </style>
</head>

<body>
<div class="dashboard">
  <div class="warning">
    System ya Account ka misuse karoge to ID block ho sakti hai.
  </div>

  <div class="box">
    <h2>Profile Settings</h2>
    <img id="userPhoto" class="profile-img" src="https://via.placeholder.com/150" alt="Profile Photo"><br>
    <h3 id="userName">Loading...</h3>
    <input type="text" id="nameInput" placeholder="Enter Your Name">
    <input type="file" id="photoInput">
    <button onclick="updateProfileData()">Update Profile</button>
    <button onclick="logout()">Logout</button>
  </div>

  <div class="box">
    <h2>Earnings Overview</h2>
    <p>Uploader Earnings: <span id="uploaderEarning">0 ₹</span></p>
    <p>Downloader Earnings: <span id="downloaderEarning">0 ₹</span></p>
  </div>

  <div class="box">
    <h2>Upload New App</h2>
    <input type="text" id="appName" placeholder="App Name">
    <textarea id="appDesc" placeholder="App Description"></textarea>
    <input type="file" id="appScreenshots" multiple accept="image/*">
    <input type="file" id="appVideo" accept="video/mp4">
    <input type="file" id="appApk" accept=".apk">
    <h4>Optional: Enter AdMob IDs</h4>
    <input type="text" id="bannerAd" placeholder="Banner Ad ID">
    <input type="text" id="interstitialAd" placeholder="Interstitial Ad ID">
    <input type="text" id="rewardedAd" placeholder="Rewarded Ad ID">
    <input type="text" id="nativeAd" placeholder="Native Ad ID">
    <input type="text" id="appOpenAd" placeholder="App Open Ad ID">
    <button onclick="uploadApp()">Upload App</button>
  </div>

  <div class="box">
    <h2>Withdraw Earnings</h2>
    <input type="text" id="bankName" placeholder="Bank Name">
    <input type="text" id="accountNumber" placeholder="Account Number">
    <input type="text" id="ifscCode" placeholder="IFSC Code">
    <input type="number" id="withdrawAmount" placeholder="Withdraw Amount ₹">
    <input type="file" id="proofPhoto" accept="image/*">
    <button onclick="requestWithdraw()">Request Withdraw</button>
  </div>

  <div class="box">
    <h2>My Uploaded Apps</h2>
    <ul id="uploadedApps">Loading...</ul>
  </div>

  <div class="box">
    <h2>Admin System Lock</h2>
    <input type="password" id="newPassword" placeholder="Enter New System Password">
    <button onclick="changePassword()">Change Password</button>
  </div>
</div>
</body>
</html>


        


  
