<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sajku1 Dashboard - Full System</title>

  <!-- Firebase Scripts -->
  <script type="module">
    // Firebase Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
    import { getDatabase, ref as dbRef, set as dbSet, onValue } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCO6p2DX7cb19ELNHbsDl0ZRQ7kgMvUzGs",
      authDomain: "sajku-store.firebaseapp.com",
      projectId: "sajku-store",
      storageBucket: "sajku-store.appspot.com",
      messagingSenderId: "831227140840",
      appId: "1:831227140840:web:634cc6248ead6ab186075d",
      measurementId: "G-BDH8FP9R56",
      databaseURL: "https://sajku-store-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();
    const rtdb = getDatabase();
    const storage = getStorage();

    // Admin password (Default inside Firestore 'admin/password')
    let systemPassword = "";
    async function getSystemPassword() {
      const passDoc = await getDoc(doc(db, "admin", "password"));
      if (passDoc.exists()) {
        systemPassword = passDoc.data().pass;
      }
    }
    getSystemPassword();

    // User Session
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        document.getElementById('userName').innerText = user.displayName || "No Name";
        document.getElementById('userPhoto').src = user.photoURL || "https://via.placeholder.com/150";
        fetchEarnings(user.uid);
        fetchUploads(user.uid);
      } else {
        window.location.href = "login.html";
      }
    });

    // Profile Update
    window.updateProfileData = async () => {
      const name = document.getElementById('nameInput').value;
      const photo = document.getElementById('photoInput').files[0];
      const user = auth.currentUser;
      if (!user) return alert("User Not Found!");

      if (photo) {
        const photoRef = storageRef(storage, `profilePics/${user.uid}`);
        await uploadBytes(photoRef, photo);
        const photoURL = await getDownloadURL(photoRef);
        await updateProfile(user, { displayName: name, photoURL });
        await updateDoc(doc(db, "users", user.uid), { name, photoURL });
        document.getElementById('userName').innerText = name;
        document.getElementById('userPhoto').src = photoURL;
      } else {
        await updateProfile(user, { displayName: name });
        await updateDoc(doc(db, "users", user.uid), { name });
        document.getElementById('userName').innerText = name;
      }
      alert("Profile Updated Successfully!");
    };

    // Upload New App
    window.uploadApp = async () => {
      const appName = document.getElementById('appName').value;
      const description = document.getElementById('appDesc').value;
      const screenshots = document.getElementById('appScreenshots').files;
      const video = document.getElementById('appVideo').files[0];
      const apk = document.getElementById('appApk').files[0];
      const admob = {
        banner: document.getElementById('bannerAd').value || "ca-app-pub-5534254536913287/6837788351",
        interstitial: document.getElementById('interstitialAd').value || "ca-app-pub-5534254536913287/6044824702",
        rewarded: document.getElementById('rewardedAd').value || "ca-app-pub-5534254536913287/7212596405",
        native: document.getElementById('nativeAd').value || "ca-app-pub-5534254536913287/3273351397",
        appOpen: document.getElementById('appOpenAd').value || "ca-app-pub-5534254536913287/7021024718"
      };

      if (!appName || !description || screenshots.length === 0 || !apk) {
        return alert("Fill all fields correctly before Upload!");
      }

      const user = auth.currentUser;
      const appDoc = await addDoc(collection(db, "apps"), {
        uploader: user.uid,
        appName,
        description,
        admob,
        createdAt: new Date(),
        approved: false
      });

      const uploads = [];
      for (let i = 0; i < screenshots.length; i++) {
        const file = screenshots[i];
        const sRef = storageRef(storage, `apps/${appDoc.id}/screenshot${i}.jpg`);
        uploads.push(uploadBytes(sRef, file));
      }

      if (video) {
        const vRef = storageRef(storage, `apps/${appDoc.id}/video.mp4`);
        uploads.push(uploadBytes(vRef, video));
      }

      const apkRef = storageRef(storage, `apps/${appDoc.id}/app.apk`);
      uploads.push(uploadBytes(apkRef, apk));

      await Promise.all(uploads);
      alert("App Uploaded Successfully! Waiting for Admin Approval.");
    };

    // Fetch Earnings
    async function fetchEarnings(uid) {
      onValue(dbRef(rtdb, `earnings/${uid}`), (snapshot) => {
        const data = snapshot.val() || { uploader: 0, downloader: 0 };
        document.getElementById('uploaderEarning').innerText = `${data.uploader} ₹`;
        document.getElementById('downloaderEarning').innerText = `${data.downloader} ₹`;
      });
    }

    // Fetch Uploaded Apps
    async function fetchUploads(uid) {
      onSnapshot(collection(db, "apps"), (snapshot) => {
        const uploads = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.uploader === uid) {
            uploads.push(`<li>${data.appName} - <button onclick="openApp('${doc.id}')">Open</button></li>`);
          }
        });
        document.getElementById('uploadedApps').innerHTML = uploads.join("") || "No Apps Uploaded.";
      });
    }

    // Open App Function
    window.openApp = (id) => {
      window.location.href = `view-app.html?id=${id}`;
    };

    // Logout
    window.logout = () => {
      signOut(auth);
    };

    // Withdraw Request
    window.requestWithdraw = async () => {
      const amount = document.getElementById('withdrawAmount').value;
      const bankName = document.getElementById('bankName').value;
      const accountNumber = document.getElementById('accountNumber').value;
      const ifscCode = document.getElementById('ifscCode').value;
      const user = auth.currentUser;
      if (!user || !amount || amount <= 0) return alert("Invalid Withdraw Information!");

      await addDoc(collection(db, "withdraws"), {
        userId: user.uid,
        amount,
        bankName,
        accountNumber,
        ifscCode,
        requestedAt: new Date()
      });
      alert("Withdraw Request Submitted Successfully!");
    };

    // Admin Password Change
    window.changePassword = async () => {
      const newPassword = document.getElementById('newPassword').value;
      if (!newPassword) return alert("Enter a New Password!");
      await setDoc(doc(db, "admin", "password"), { pass: newPassword });
      alert("Password Changed Successfully!");
    };

    // Admin Lock System
    let adminAttempts = 3;
    window.verifyAdminPassword = () => {
      const inputPass = document.getElementById('adminPasswordInput').value.trim();
      if (inputPass === systemPassword) {
        document.getElementById('lockScreen').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
      } else {
        adminAttempts--;
        if (adminAttempts <= 0) {
          document.getElementById('lockScreen').innerHTML = "<p style='color:red; font-weight:bold;'>Access Denied Permanently!</p>";
        } else {
          document.getElementById('attemptsLeft').innerText = `Wrong Password! ${adminAttempts} attempts left.`;
        }
      }
    };
  </script>

  <!-- CSS Styles -->
  <style>
    body {
      background: linear-gradient(135deg, #2193b0, #6dd5ed);
      font-family: 'Arial', sans-serif;
      color: #fff;
      margin: 0;
      padding: 20px;
    }
    .dashboard {
      max-width: 900px;
      margin: auto;
    }
    .box {
      background: white;
      color: black;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    h2 {
      color: #2193b0;
    }
    input, textarea, button {
      width: 100%;
      margin-top: 10px;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
    }
    button {
      background: #2193b0;
      color: white;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background: #6dd5ed;
    }
    .profile-img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 50%;
      margin-bottom: 15px;
    }
    ul {
      list-style-type: none;
      padding: 0;
    }
  </style>
</head>

<body>

<div class="dashboard">

  <!-- Profile Section -->
  <div class="box">
    <h2>Profile Settings</h2>
    <img id="userPhoto" class="profile-img" src="https://via.placeholder.com/150" alt="Profile Photo"><br>
    <h3 id="userName">Loading...</h3>
    <input type="text" id="nameInput" placeholder="Enter Your Name">
    <input type="file" id="photoInput">
    <button onclick="updateProfileData()">Update Profile</button>
    <button onclick="logout()">Logout</button>
  </div>

  <!-- Earnings Section -->
  <div class="box">
    <h2>Earnings Overview</h2>
    <p>Uploader Earnings: <span id="uploaderEarning">0 ₹</span></p>
    <p>Downloader Earnings: <span id="downloaderEarning">0 ₹</span></p>
  </div>

  <!-- Upload New App -->
  <div class="box">
    <h2>Upload New App</h2>
    <input type="text" id="appName" placeholder="App Name">
    <textarea id="appDesc" placeholder="App Description"></textarea>
    <input type="file" id="appScreenshots" multiple accept="image/*">
    <input type="file" id="appVideo" accept="video/mp4">
    <input type="file" id="appApk" accept=".apk">
    <h4>AdMob Codes (Optional)</h4>
    <input type="text" id="bannerAd" placeholder="Banner Ad ID">
    <input type="text" id="interstitialAd" placeholder="Interstitial Ad ID">
    <input type="text" id="rewardedAd" placeholder="Rewarded Ad ID">
    <input type="text" id="nativeAd" placeholder="Native Ad ID">
    <input type="text" id="appOpenAd" placeholder="App Open Ad ID">
    <button onclick="uploadApp()">Upload App</button>
  </div>

  <!-- Uploaded Apps -->
  <div class="box">
    <h2>My Uploaded Apps</h2>
    <ul id="uploadedApps">Loading...</ul>
  </div>

  <!-- Admin System Lock Panel -->
  <div class="box" id="adminBox">
    <h2>Admin System Lock</h2>
    <p style="color: red; font-weight: bold;">** Sher Shayari Ya Galat Prayog Karoge To ID Permanent Band Ho Sakti Hai **</p>

    <div id="lockScreen">
      <input type="password" id="adminPasswordInput" placeholder="Enter System Password">
      <button onclick="verifyAdminPassword()">Unlock Admin Panel</button>
      <p id="attemptsLeft" style="color:red; margin-top:10px;"></p>
    </div>

    <div id="adminPanel" style="display:none;">
      <h3>Withdraw Earnings</h3>
      <input type="text" id="bankName" placeholder="Bank Name">
      <input type="text" id="accountNumber" placeholder="Account Number">
      <input type="text" id="ifscCode" placeholder="IFSC Code">
      <input type="number" id="withdrawAmount" placeholder="Withdraw Amount ₹">
      <button onclick="requestWithdraw()">Request Withdraw</button>

      <hr style="margin:20px 0;">

      <h3>Change System Password</h3>
      <input type="password" id="newPassword" placeholder="Enter New System Password">
      <button onclick="changePassword()">Change Password</button>
    </div>
  </div>

</div>

</body>
</html>


        


  
