<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sajku1 Dashboard - Final Updated</title>
  <link rel="manifest" href="/manifest.json">
  <!-- Firebase Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
    import { getDatabase, ref as dbRef, set as dbSet, onValue } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-storage.js";
    import { getMessaging, getToken, onMessage, isSupported } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-messaging.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCO6p2DX7cb19ELNHbsDl0ZRQ7kgMvUzGs",
      authDomain: "sajku-store.firebaseapp.com",
      projectId: "sajku-store",
      storageBucket: "sajku-store.appspot.com",
      messagingSenderId: "831227140840",
      appId: "1:831227140840:web:634cc6248ead6ab186075d",
      measurementId: "G-BDH8FP9R56",
      databaseURL: "https://sajku-store-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();
    const rtdb = getDatabase();
    const storage = getStorage();
    let messaging;

    // Check internet connection
    function checkInternet() {
      if (!navigator.onLine) {
        document.body.innerHTML = `
          <div style="text-align:center; padding:50px; color:white; background:red;">
            <h1>No Internet Connection</h1>
            <p>This dashboard requires internet to function. Please connect to the internet and refresh the page.</p>
          </div>
        `;
        throw new Error("No internet connection");
      }
    }
    checkInternet();
    window.addEventListener('offline', checkInternet);

    // Initialize Firebase Messaging if supported
    (async () => {
      if (await isSupported()) {
        messaging = getMessaging(app);
        initFCM();
      }
    })();

    let systemPassword = "";
    let passwordAttempts = 0;
    let systemBlocked = false;

    async function getSystemPassword() {
      const passDoc = await getDoc(doc(db, "admin", "password"));
      if (passDoc.exists()) {
        systemPassword = passDoc.data().pass;
      }
    }
    getSystemPassword();

    // FCM Initialization
    async function initFCM() {
      try {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
          const currentToken = await getToken(messaging, { 
            vapidKey: 'BE480YruByxBzIc6J_6YLquolt0b3difUjIQJD1_VrLJ4xbH15Ya72xNAy9k25enW8WoSFYM6IFtUH3JgWNiS0'
          });
          if (currentToken && auth.currentUser) {
            await setDoc(doc(db, "fcm_tokens", auth.currentUser.uid), {
              token: currentToken,
              createdAt: new Date()
            });
          }
        }

        onMessage(messaging, (payload) => {
          console.log('Message received:', payload);
          showNotification(
            payload.notification.title || 'New Notification',
            payload.notification.body || 'You have a new update'
          );
        });
      } catch (error) {
        console.error('FCM Error:', error);
      }
    }

    function showNotification(title, body) {
      if (Notification.permission === 'granted') {
        new Notification(title, { 
          body, 
          icon: '/icon-192x192.png',
          vibrate: [200, 100, 200]
        });
      } else {
        // Fallback for browsers that don't support notifications
        alert(`${title}\n${body}`);
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        document.getElementById('userName').innerText = user.displayName || "No Name";
        document.getElementById('userPhoto').src = user.photoURL || "https://via.placeholder.com/150";
        fetchEarnings(user.uid);
        fetchUploads(user.uid);
        setupNotificationListener(user.uid);
      } else {
        window.location.href = "login.html";
      }
    });

    function setupNotificationListener(uid) {
      const notificationsRef = collection(db, "notifications");
      onSnapshot(notificationsRef, (snapshot) => {
        snapshot.docChanges().forEach(change => {
          if (change.type === "added" && change.doc.data().userId === uid) {
            const data = change.doc.data();
            showNotification(data.title, data.message);
          }
        });
      });
    }

    window.updateProfileData = async () => {
      checkInternet();
      const name = document.getElementById('nameInput').value;
      const photo = document.getElementById('photoInput').files[0];
      const user = auth.currentUser;
      if (!user) return alert("User Not Found!");

      try {
        if (photo) {
          const photoRef = storageRef(storage, `profilePics/${user.uid}`);
          await uploadBytes(photoRef, photo);
          const photoURL = await getDownloadURL(photoRef);
          await updateProfile(user, { displayName: name, photoURL });
          await updateDoc(doc(db, "users", user.uid), { name, photoURL });
          document.getElementById('userName').innerText = name;
          document.getElementById('userPhoto').src = photoURL;
        } else {
          await updateProfile(user, { displayName: name });
          await updateDoc(doc(db, "users", user.uid), { name });
          document.getElementById('userName').innerText = name;
        }
        
        await addDoc(collection(db, "notifications"), {
          userId: user.uid,
          title: "Profile Updated",
          message: "Your profile has been successfully updated",
          timestamp: new Date()
        });
        
        alert("Profile Updated Successfully!");
      } catch (error) {
        alert("Error updating profile: " + error.message);
      }
    };

    window.uploadApp = async () => {
      checkInternet();
      const appName = document.getElementById('appName').value.trim();
      const description = document.getElementById('appDesc').value.trim();
      const screenshots = document.getElementById('appScreenshots').files;
      const video = document.getElementById('appVideo').files[0];
      const apk = document.getElementById('appApk').files[0];
      const user = auth.currentUser;

      if (!user || !appName || !description || screenshots.length === 0 || !apk) {
        return alert("Please fill all required fields.");
      }

      try {
        const bannerAd = document.getElementById('bannerAd').value || "ca-app-pub-5534254536913287/6837788351";
        const interstitialAd = document.getElementById('interstitialAd').value || "ca-app-pub-5534254536913287/6044824702";
        const rewardedAd = document.getElementById('rewardedAd').value || "ca-app-pub-5534254536913287/7212596405";
        const nativeAd = document.getElementById('nativeAd').value || "ca-app-pub-5534254536913287/3273351397";
        const appOpenAd = document.getElementById('appOpenAd').value || "ca-app-pub-5534254536913287/7021024718";

        const appDoc = await addDoc(collection(db, "apps"), {
          uploader: user.uid,
          appName,
          description,
          admob: { banner: bannerAd, interstitial: interstitialAd, rewarded: rewardedAd, native: nativeAd, appOpen: appOpenAd },
          createdAt: new Date(),
          approved: false,
          status: "uploading"
        });

        const uploads = [];
        for (let i = 0; i < screenshots.length; i++) {
          const sRef = storageRef(storage, `apps/${appDoc.id}/screenshot${i}.jpg`);
          uploads.push(uploadBytes(sRef, screenshots[i]));
        }

        if (video) {
          const vRef = storageRef(storage, `apps/${appDoc.id}/video.mp4`);
          uploads.push(uploadBytes(vRef, video));
        }

        const apkRef = storageRef(storage, `apps/${appDoc.id}/app.apk`);
        uploads.push(uploadBytes(apkRef, apk));

        await Promise.all(uploads);
        
        await updateDoc(doc(db, "apps", appDoc.id), { status: "pending_approval" });
        
        // Send notification
        await addDoc(collection(db, "notifications"), {
          userId: user.uid,
          title: "App Uploaded",
          message: `${appName} has been uploaded and is pending approval`,
          timestamp: new Date(),
          appId: appDoc.id
        });

        alert("App Uploaded Successfully! Waiting for Admin Approval.");
      } catch (error) {
        alert("Error uploading app: " + error.message);
      }
    };

    let userEarnings = { uploader: 0, downloader: 0 };
    async function fetchEarnings(uid) {
      onValue(dbRef(rtdb, `earnings/${uid}`), (snapshot) => {
        const data = snapshot.val() || { uploader: 0, downloader: 0 };
        userEarnings = data;
        document.getElementById('uploaderEarning').innerText = `${data.uploader} ₹`;
        document.getElementById('downloaderEarning').innerText = `${data.downloader} ₹`;
        
        // Send earning update notification if changed
        if (data.uploader > 0 || data.downloader > 0) {
          addDoc(collection(db, "notifications"), {
            userId: uid,
            title: "Earnings Updated",
            message: `Your current balance: Uploader ₹${data.uploader} | Downloader ₹${data.downloader}`,
            timestamp: new Date()
          });
        }
      });
    }

    async function fetchUploads(uid) {
      onSnapshot(collection(db, "apps"), (snapshot) => {
        const uploads = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.uploader === uid) {
            const statusBadge = data.approved ? 
              '<span style="color:green">✓ Approved</span>' : 
              '<span style="color:orange">⏳ Pending</span>';
            
            uploads.push(`
              <li style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 8px;">
                <strong>${data.appName}</strong> - ${statusBadge}
                <div style="margin-top: 5px;">
                  <button onclick="openApp('${doc.id}')" style="background: #2193b0;">Open</button>
                  <input type="text" id="interstitialAppId" placeholder="Interstitial Ad ID" value="${data.admob.interstitial}" style="width: 60%;">
                  <button id="loadInterstitial" style="width: 35%;">Load Ad</button>
                </div>
                ${data.status === 'approved' ? 
                  `<p style="color:green; margin-top:5px;">✓ Ready for downloads</p>` : ''}
              </li>
            `);
          }
        });
        document.getElementById('uploadedApps').innerHTML = uploads.join("") || "No Apps Uploaded.";
        
        document.querySelectorAll("#loadInterstitial").forEach(btn => {
          btn.addEventListener("click", function() {
            const appId = this.parentNode.querySelector("#interstitialAppId").value;
            alert(`Interstitial Ad Loaded for ${appId}`);
          });
        });
      });
    }

    window.openApp = (id) => {
      window.location.href = `view-app.html?id=${id}`;
    };

    window.logout = async () => {
      try {
        await signOut(auth);
        window.location.href = "index.html";
      } catch (error) {
        console.error("Logout error:", error);
        window.location.href = "index.html";
      }
    };

    window.goToHome = () => {
      window.location.href = "home.html";
    };

    window.requestWithdraw = async () => {
      checkInternet();
      const amount = Number(document.getElementById('withdrawAmount').value);
      const bankName = document.getElementById('bankName').value.trim();
      const accountNumber = document.getElementById('accountNumber').value.trim();
      const ifscCode = document.getElementById('ifscCode').value.trim();
      const proofPhoto = document.getElementById('proofPhoto').files[0];
      const user = auth.currentUser;
      
      if (!user || amount <= 0 || !bankName || !accountNumber || !ifscCode || !proofPhoto) {
        return alert("Please fill all fields and upload proof photo.");
      }

      const totalEarning = userEarnings.uploader + userEarnings.downloader;
      if (amount > totalEarning) {
        return alert("Insufficient Balance!");
      }

      try {
        const proofRef = storageRef(storage, `withdrawProofs/${user.uid}_${Date.now()}.jpg`);
        await uploadBytes(proofRef, proofPhoto);
        const proofURL = await getDownloadURL(proofRef);

        await addDoc(collection(db, "withdraws"), {
          userId: user.uid,
          amount,
          bankName,
          accountNumber,
          ifscCode,
          proofPhotoURL: proofURL,
          requestedAt: new Date(),
          status: "pending"
        });

        // Send notification
        await addDoc(collection(db, "notifications"), {
          userId: user.uid,
          title: "Withdrawal Requested",
          message: `Your withdrawal request of ₹${amount} has been submitted`,
          timestamp: new Date()
        });

        alert("Withdraw Request Submitted Successfully with Proof!");
      } catch (error) {
        alert("Error processing withdrawal: " + error.message);
      }
    };

    window.changePassword = async () => {
      checkInternet();
      if (systemBlocked) {
        return alert("System permanently blocked due to wrong password attempts.");
      }
      const enteredPassword = prompt("Enter System Password:");
      if (enteredPassword !== systemPassword) {
        passwordAttempts++;
        if (passwordAttempts >= 3) {
          systemBlocked = true;
          alert("System permanently blocked!");
        } else {
          alert("Wrong Password! Attempts left: " + (3 - passwordAttempts));
        }
        return;
      }
      const newPassword = document.getElementById('newPassword').value.trim();
      if (!newPassword) return alert("Please enter a new password.");
      await setDoc(doc(db, "admin", "password"), { pass: newPassword });
      systemPassword = newPassword;
      passwordAttempts = 0;
      alert("Password Changed Successfully!");
    };

    // Add powerful lighting effect
    function addLightingEffect() {
      const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
      let currentIndex = 0;
      
      setInterval(() => {
        document.body.style.boxShadow = `0 0 50px ${colors[currentIndex]}`;
        currentIndex = (currentIndex + 1) % colors.length;
      }, 500);
    }
    addLightingEffect();
  </script>

  <style>
    body {
      background: linear-gradient(135deg, #2193b0, #6dd5ed);
      font-family: 'Arial', sans-serif;
      color: #fff;
      margin: 0;
      padding: 20px;
      transition: box-shadow 0.5s ease;
      animation: pulseBackground 10s infinite alternate;
    }
    @keyframes pulseBackground {
      0% { background: linear-gradient(135deg, #2193b0, #6dd5ed); }
      25% { background: linear-gradient(135deg, #6dd5ed, #2193b0); }
      50% { background: linear-gradient(135deg, #ff5722, #ff9800); }
      75% { background: linear-gradient(135deg, #9c27b0, #e91e63); }
      100% { background: linear-gradient(135deg, #4caf50, #8bc34a); }
    }
    .dashboard {
      max-width: 900px;
      margin: auto;
    }
    .box {
      background: white;
      color: black;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .box:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    h2 { 
      color: #2193b0;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }
    input, textarea, button {
      width: 100%;
      margin-top: 10px;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      transition: all 0.3s;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: #2193b0;
      box-shadow: 0 0 5px rgba(33, 147, 176, 0.5);
    }
    button {
      background: #2193b0;
      color: white;
      cursor: pointer;
      transition: 0.3s;
      border: none;
      font-weight: bold;
    }
    button:hover {
      background: #6dd5ed;
      transform: scale(1.02);
    }
    .profile-img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 50%;
      margin-bottom: 15px;
      border: 3px solid #2193b0;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    ul { list-style-type: none; padding: 0; }
    .warning {
      background-color: red;
      color: white;
      padding: 10px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 20px;
      font-weight: bold;
      animation: blinkWarning 1s infinite alternate;
    }
    @keyframes blinkWarning {
      from { opacity: 0.8; }
      to { opacity: 1; }
    }
    .upload-guidelines {
      background:linear-gradient(to right, #e3f2fd, #bbdefb);
      padding:20px 25px;
      border-left:6px solid #1976d2;
      border-radius:12px;
      box-shadow:0 4px 8px rgba(0,0,0,0.1);
      margin-bottom:25px;
      font-family:sans-serif;
    }
    .upload-guidelines h2 {
      color:#0d47a1;
      margin-top:0;
      text-shadow: 1px 1px 1px rgba(0,0,0,0.1);
    }
    .upload-guidelines ul {
      padding-left:20px;
      margin:15px 0;
      line-height:1.8;
      color:#212121;
    }
    #notification-bell {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #ff5722;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: transform 0.3s;
    }
    #notification-bell:hover {
      transform: scale(1.1) rotate(15deg);
    }
    #notification-count {
      position: absolute;
      top: -5px;
      right: -5px;
      background: red;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .power-button {
      background: linear-gradient(to right, #ff416c, #ff4b2b);
      color: white;
      padding: 10px 15px;
      border-radius: 50px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 4px 15px rgba(255, 65, 108, 0.4);
      transition: all 0.3s;
    }
    .power-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 7px 20px rgba(255, 65, 108, 0.6);
    }
  </style>
</head>

<body>
  <div id="notification-bell" onclick="showNotifications()">
    <i class="fas fa-bell"></i>
    <span id="notification-count" style="display: none;">0</span>
  </div>

  <div class="dashboard">
    <div class="warning">
      System ya Account ka misuse karoge to ID block ho sakti hai.
    </div>

    <div class="box">
      <h2>Profile Settings</h2>
      <img id="userPhoto" class="profile-img" src="https://via.placeholder.com/150" alt="Profile Photo"><br>
      <h3 id="userName">Loading...</h3>
      <input type="text" id="nameInput" placeholder="Enter Your Name">
      <input type="file" id="photoInput">
      <button onclick="updateProfileData()">Update Profile</button>
      <button onclick="logout()" style="background: #f44336;">Logout</button>
      <button onclick="goToHome()" style="background: #4CAF50; margin-top: 10px;">Go to Home Page</button
        </div>

    <div class="box">
      <h2>Earnings Overview</h2>
      <p>Uploader Earnings: <span id="uploaderEarning">0 ₹</span></p>
      <p>Downloader Earnings: <span id="downloaderEarning">0 ₹</span></p>
    </div>

    <div class="box">
      <h2>Upload New App</h2>
      <input type="text" id="appName" placeholder="App Name">
      <textarea id="appDesc" placeholder="App Description"></textarea>
      <input type="file" id="appScreenshots" multiple accept="image/*">
      <input type="file" id="appVideo" accept="video/mp4">
      <input type="file" id="appApk" accept=".apk">
      <h4>Optional: Enter AdMob IDs</h4>
      <input type="text" id="bannerAd" placeholder="Banner Ad ID">
      <input type="text" id="interstitialAd" placeholder="Interstitial Ad ID">
      <input type="text" id="rewardedAd" placeholder="Rewarded Ad ID">
      <input type="text" id="nativeAd" placeholder="Native Ad ID">
      <input type="text" id="appOpenAd" placeholder="App Open Ad ID">
      <button onclick="uploadApp()" class="power-button">Upload App</button>
    </div>

    <div class="box">
      <h2>Withdraw Earnings</h2>
      <input type="text" id="bankName" placeholder="Bank Name">
      <input type="text" id="accountNumber" placeholder="Account Number">
      <input type="text" id="ifscCode" placeholder="IFSC Code">
      <input type="number" id="withdrawAmount" placeholder="Withdraw Amount ₹">
      <input type="file" id="proofPhoto" accept="image/*">
      <button onclick="requestWithdraw()" class="power-button">Request Withdraw</button>
    </div>

    <div class="box">
      <h2>My Uploaded Apps</h2>
      <div class="upload-guidelines">
        <h2>Upload Guidelines (जरूरी जानकारी)</h2>
        <ul>
          <li>सिर्फ अपनी बनाई हुई या पूरी तरह से अधिकृत (authorized) ऐप ही अपलोड करें।</li>
          <li>कोई भी अवैध, एडल्ट, हैकिंग, कॉपीराइटेड या सरकारी नियमों के विरुद्ध ऐप अपलोड करने पर अकाउंट स्थायी रूप से बैन किया जा सकता है।</li>
          <li>अगर आप Google AdMob के 5 कोड नहीं भरते, तो सिस्टम खुद का डिफॉल्ट AdMob कोड लगाएगी।</li>
          <li>ऐसी स्थिति में भी आपकी कमाई (Upload: 65%, Download: 15%) आपको मिलती रहेगी। सिस्टम सिर्फ अपना हिस्सा (20%) लेगी।</li>
          <li>अपलोड करने से पहले कृपया सभी शर्तों को ध्यानपूर्वक पढ़ें और सहमति दें।</li>
        </ul>
      </div>
      <ul id="uploadedApps">Loading...</ul>
    </div>

    <div class="box">
      <h2>Admin System Lock</h2>
      <input type="password" id="newPassword" placeholder="Enter New System Password">
      <button onclick="changePassword()" style="background: #f44336;">Change Password</button>
    </div>
  </div>

  <script>
    // Notification bell functionality
    async function showNotifications() {
      const user = auth.currentUser;
      if (!user) return;
      
      const notificationsRef = collection(db, "notifications");
      const querySnapshot = await getDocs(query(notificationsRef, where("userId", "==", user.uid), orderBy("timestamp", "desc"), limit(10));
      
      let notificationHTML = '<h2>Your Notifications</h2><ul>';
      querySnapshot.forEach(doc => {
        const data = doc.data();
        notificationHTML += `<li><strong>${data.title}</strong><br>${data.message}</li>`;
      });
      notificationHTML += '</ul>';
      
      alert(notificationHTML);
    }

    // Check for new notifications periodically
    setInterval(async () => {
      const user = auth.currentUser;
      if (!user) return;
      
      const notificationsRef = collection(db, "notifications");
      const querySnapshot = await getDocs(query(
        notificationsRef, 
        where("userId", "==", user.uid),
        where("timestamp", ">", new Date(Date.now() - 24 * 60 * 60 * 1000)),
        orderBy("timestamp", "desc")
      ));
      
      const count = querySnapshot.size;
      const countElement = document.getElementById('notification-count');
      if (count > 0) {
        countElement.style.display = 'flex';
        countElement.innerText = count;
      } else {
        countElement.style.display = 'none';
      }
    }, 60000);
  </script>
</body>
  </html>


  
