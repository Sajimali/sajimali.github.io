<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Sajku1 Dashboard - Final Updated</title>
  <link rel="manifest" href="/manifest.json">
  <!-- Firebase Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, updateProfile, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, collection, onSnapshot, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-storage.js";
    import { getMessaging, getToken, onMessage, isSupported } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-messaging.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCO6p2DX7cb19ELNHbsDl0ZRQ7kgMvUzGs",
      authDomain: "sajku-store.firebaseapp.com",
      projectId: "sajku-store",
      storageBucket: "sajku-store.appspot.com",
      messagingSenderId: "831227140840",
      appId: "1:831227140840:web:634cc6248ead6ab186075d",
      measurementId: "G-BDH8FP9R56"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();
    const storage = getStorage();
    let messaging;

    // Set auth persistence
    setPersistence(auth, browserLocalPersistence)
      .catch((error) => {
        console.error("Persistence error:", error);
      });

    // Check internet connection
    function checkInternet() {
      if (!navigator.onLine) {
        document.body.innerHTML = `
          <div style="text-align:center; padding:50px; color:white; background:red;">
            <h1>No Internet Connection</h1>
            <p>This dashboard requires internet to function. Please connect to the internet and refresh the page.</p>
          </div>
        `;
        throw new Error("No internet connection");
      }
    }
    checkInternet();
    window.addEventListener('offline', checkInternet);

    // Initialize Firebase Messaging if supported
    (async () => {
      if (await isSupported()) {
        messaging = getMessaging(app);
        initFCM();
      }
    })();

    let systemPassword = "";
    let passwordAttempts = 0;
    let systemBlocked = false;

    async function getSystemPassword() {
      const passDoc = await getDoc(doc(db, "admin", "password"));
      if (passDoc.exists()) {
        systemPassword = passDoc.data().pass;
      }
    }
    getSystemPassword();

    // FCM Initialization
    async function initFCM() {
      try {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
          const currentToken = await getToken(messaging, { 
            vapidKey: 'BE480YruByxBzIc6J_6YLquolt0b3difUjIQJD1_VrLJ4xbH15Ya72xNAy9k25enW8WoSFYM6IFtUH3JgWNiS0'
          });
          if (currentToken && auth.currentUser) {
            await setDoc(doc(db, "fcm_tokens", auth.currentUser.uid), {
              token: currentToken,
              createdAt: new Date()
            });
          }
        }

        onMessage(messaging, (payload) => {
          console.log('Message received:', payload);
          showNotification(
            payload.notification.title || 'New Notification',
            payload.notification.body || 'You have a new update'
          );
        });
      } catch (error) {
        console.error('FCM Error:', error);
      }
    }

    function showNotification(title, body) {
      if (Notification.permission === 'granted') {
        new Notification(title, { 
          body, 
          icon: '/icon-192x192.png',
          vibrate: [200, 100, 200]
        });
      } else {
        // Fallback for browsers that don't support notifications
        alert(`${title}\n${body}`);
      }
    }

    // Fixed auth state handler with proper redirection logic
    onAuthStateChanged(auth, (user) => {
      const currentPath = window.location.pathname;
      
      if (!user) {
        // User not logged in - redirect to login if not already there
        if (!currentPath.includes('index.html')) {
          window.location.href = "index.html";
        }
      } else {
        // User is logged in - show content
        document.getElementById('content').style.display = 'block';
        document.getElementById('userName').innerText = user.displayName || "No Name";
        document.getElementById('userPhoto').src = user.photoURL || "https://via.placeholder.com/150";
        
        // Only redirect if coming from auth pages
        if (currentPath.includes('index.html') || currentPath.includes('signup.html')) {
          window.location.href = "home.html";
        }
        
        fetchEarnings(user.uid);
        fetchUploads(user.uid);
        setupNotificationListener(user.uid);
      }
    });

    function setupNotificationListener(uid) {
      const notificationsRef = collection(db, "notifications");
      onSnapshot(notificationsRef, (snapshot) => {
        snapshot.docChanges().forEach(change => {
          if (change.type === "added" && change.doc.data().userId === uid) {
            const data = change.doc.data();
            showNotification(data.title, data.message);
          }
        });
      });
    }

    // Dark mode toggle functionality
    function toggleDarkMode() {
      const body = document.body;
      body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', body.classList.contains('dark-mode'));
    }

    // Check for saved dark mode preference
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark-mode');
    }

    window.updateProfileData = async () => {
      checkInternet();
      const name = document.getElementById('nameInput').value;
      const photo = document.getElementById('photoInput').files[0];
      const user = auth.currentUser;
      if (!user) return alert("User Not Found!");

      try {
        if (photo) {
          const photoRef = storageRef(storage, `profilePics/${user.uid}`);
          await uploadBytes(photoRef, photo);
          const photoURL = await getDownloadURL(photoRef);
          await updateProfile(user, { displayName: name, photoURL });
          await setDoc(doc(db, "users", user.uid), { 
            name, 
            photoURL,
            lastUpdated: new Date() 
          }, { merge: true });
          document.getElementById('userName').innerText = name;
          document.getElementById('userPhoto').src = photoURL;
        } else {
          await updateProfile(user, { displayName: name });
          await setDoc(doc(db, "users", user.uid), { 
            name,
            lastUpdated: new Date()
          }, { merge: true });
          document.getElementById('userName').innerText = name;
        }
        
        await addDoc(collection(db, "notifications"), {
          userId: user.uid,
          title: "Profile Updated",
          message: "Your profile has been successfully updated",
          timestamp: new Date()
        });
        
        alert("Profile Updated Successfully!");
      } catch (error) {
        alert("Error updating profile: " + error.message);
      }
    };

    window.uploadApp = async () => {
      checkInternet();
      const appName = document.getElementById('appName').value.trim();
      const description = document.getElementById('appDesc').value.trim();
      const screenshots = document.getElementById('appScreenshots').files;
      const video = document.getElementById('appVideo').files[0];
      const apk = document.getElementById('appApk').files[0];
      const user = auth.currentUser;

      if (!user || !appName || !description || screenshots.length === 0 || !apk) {
        return alert("Please fill all required fields.");
      }

      try {
        const bannerAd = document.getElementById('bannerAd').value || "ca-app-pub-5534254536913287/6837788351";
        const interstitialAd = document.getElementById('interstitialAd').value || "ca-app-pub-5534254536913287/6044824702";
        const rewardedAd = document.getElementById('rewardedAd').value || "ca-app-pub-5534254536913287/7212596405";
        const nativeAd = document.getElementById('nativeAd').value || "ca-app-pub-5534254536913287/3273351397";
        const appOpenAd = document.getElementById('appOpenAd').value || "ca-app-pub-5534254536913287/7021024718";

        const appDoc = await addDoc(collection(db, "apps"), {
          uploader: user.uid,
          appName,
          description,
          admob: { banner: bannerAd, interstitial: interstitialAd, rewarded: rewardedAd, native: nativeAd, appOpen: appOpenAd },
          createdAt: new Date(),
          approved: false,
          status: "uploading"
        });

        const uploads = [];
        for (let i = 0; i < screenshots.length; i++) {
          const sRef = storageRef(storage, `apps/${appDoc.id}/screenshot${i}.jpg`);
          uploads.push(uploadBytes(sRef, screenshots[i]));
        }

        if (video) {
          const vRef = storageRef(storage, `apps/${appDoc.id}/video.mp4`);
          uploads.push(uploadBytes(vRef, video));
        }

        const apkRef = storageRef(storage, `apps/${appDoc.id}/app.apk`);
        uploads.push(uploadBytes(apkRef, apk));

        await Promise.all(uploads);
        
        await updateDoc(doc(db, "apps", appDoc.id), { status: "pending_approval" });
        
        // Send notification
        await addDoc(collection(db, "notifications"), {
          userId: user.uid,
          title: "App Uploaded",
          message: `${appName} has been uploaded and is pending approval`,
          timestamp: new Date(),
          appId: appDoc.id
        });

        alert("App Uploaded Successfully! Waiting for Admin Approval.");
      } catch (error) {
        alert("Error uploading app: " + error.message);
      }
    };

    let userEarnings = { uploader: 0, downloader: 0 };
    async function fetchEarnings(uid) {
      const earningsRef = doc(db, "earnings", uid);
      onSnapshot(earningsRef, (docSnapshot) => {
        const data = docSnapshot.exists() ? docSnapshot.data() : { uploader: 0, downloader: 0 };
        userEarnings = data;
        document.getElementById('uploaderEarning').innerText = `${data.uploader || 0} ₹`;
        document.getElementById('downloaderEarning').innerText = `${data.downloader || 0} ₹`;
        
        // Send earning update notification if changed
        if (data.uploader > 0 || data.downloader > 0) {
          addDoc(collection(db, "notifications"), {
            userId: uid,
            title: "Earnings Updated",
            message: `Your current balance: Uploader ₹${data.uploader || 0} | Downloader ₹${data.downloader || 0}`,
            timestamp: new Date()
          });
        }
      });
    }

    async function fetchUploads(uid) {
      onSnapshot(collection(db, "apps"), (snapshot) => {
        const uploads = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.uploader === uid) {
            const statusBadge = data.approved ? 
              '<span style="color:green">✓ Approved</span>' : 
              '<span style="color:orange">⏳ Pending</span>';
            
            uploads.push(`
              <li style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 8px;">
                <strong>${data.appName}</strong> - ${statusBadge}
                <div style="margin-top: 5px;">
                  <button onclick="openApp('${doc.id}')" style="background: #2193b0;">Open</button>
                  <input type="text" id="interstitialAppId" placeholder="Interstitial Ad ID" value="${data.admob.interstitial}" style="width: 60%;">
                  <button id="loadInterstitial" style="width: 35%;">Load Ad</button>
                </div>
                ${data.status === 'approved' ? 
                  `<p style="color:green; margin-top:5px;">✓ Ready for downloads</p>` : ''}
              </li>
            `);
          }
        });
        document.getElementById('uploadedApps').innerHTML = uploads.join("") || "No Apps Uploaded.";
        
        document.querySelectorAll("#loadInterstitial").forEach(btn => {
          btn.addEventListener("click", function() {
            const appId = this.parentNode.querySelector("#interstitialAppId").value;
            alert(`Interstitial Ad Loaded for ${appId}`);
          });
        });
      });
    }

    window.openApp = (id) => {
      window.location.href = `view-app.html?id=${id}`;
    };

    window.logout = async () => {
      try {
        await signOut(auth);
        window.location.href = "index.html";
      } catch (error) {
        console.error("Logout error:", error);
        window.location.href = "index.html";
      }
    };

    window.goToHome = () => {
      window.location.href = "home.html";
    };

    window.requestWithdraw = async () => {
      checkInternet();
      const amount = Number(document.getElementById('withdrawAmount').value);
      const bankName = document.getElementById('bankName').value.trim();
      const accountNumber = document.getElementById('accountNumber').value.trim();
      const ifscCode = document.getElementById('ifscCode').value.trim();
      const proofPhoto = document.getElementById('proofPhoto').files[0];
      const user = auth.currentUser;
      
      if (!user || amount <= 0 || !bankName || !accountNumber || !ifscCode || !proofPhoto) {
        return alert("Please fill all fields and upload proof photo.");
      }

      const totalEarning = (userEarnings.uploader || 0) + (userEarnings.downloader || 0);
      if (amount > totalEarning) {
        return alert("Insufficient Balance!");
      }

      try {
        const proofRef = storageRef(storage, `withdrawProofs/${user.uid}_${Date.now()}.jpg`);
        await uploadBytes(proofRef, proofPhoto);
        const proofURL = await getDownloadURL(proofRef);

        await addDoc(collection(db, "withdraws"), {
          userId: user.uid,
          amount,
          bankName,
          accountNumber,
          ifscCode,
          proofPhotoURL: proofURL,
          requestedAt: new Date(),
          status: "pending"
        });

        // Send notification
        await addDoc(collection(db, "notifications"), {
          userId: user.uid,
          title: "Withdrawal Requested",
          message: `Your withdrawal request of ₹${amount} has been submitted`,
          timestamp: new Date()
        });

        alert("Withdraw Request Submitted Successfully with Proof!");
      } catch (error) {
        alert("Error processing withdrawal: " + error.message);
      }
    };

    window.changePassword = async () => {
      checkInternet();
      if (systemBlocked) {
        return alert("System permanently blocked due to wrong password attempts.");
      }
      const enteredPassword = prompt("Enter System Password:");
      if (enteredPassword !== systemPassword) {
        passwordAttempts++;
        if (passwordAttempts >= 3) {
          systemBlocked = true;
          alert("System permanently blocked!");
        } else {
          alert("Wrong Password! Attempts left: " + (3 - passwordAttempts));
        }
        return;
      }
      const newPassword = document.getElementById('newPassword').value.trim();
      if (!newPassword) return alert("Please enter a new password.");
      await setDoc(doc(db, "admin", "password"), { pass: newPassword });
      systemPassword = newPassword;
      passwordAttempts = 0;
      alert("Password Changed Successfully!");
    };

    // Add dark mode toggle button to the UI
    document.addEventListener('DOMContentLoaded', () => {
      const darkModeToggle = document.createElement('button');
      darkModeToggle.textContent = 'Toggle Dark Mode';
      darkModeToggle.style.position = 'fixed';
      darkModeToggle.style.bottom = '20px';
      darkModeToggle.style.right = '20px';
      darkModeToggle.style.zIndex = '1000';
      darkModeToggle.style.padding = '10px';
      darkModeToggle.style.borderRadius = '5px';
      darkModeToggle.style.backgroundColor = '#2193b0';
      darkModeToggle.style.color = 'white';
      darkModeToggle.style.border = 'none';
      darkModeToggle.style.cursor = 'pointer';
      darkModeToggle.addEventListener('click', toggleDarkMode);
      document.body.appendChild(darkModeToggle);
    });

    // Prevent zooming on mobile devices
    document.addEventListener('touchmove', function(event) {
      if (event.scale !== 1) { event.preventDefault(); }
    }, { passive: false });

    // Add viewport meta tag to prevent zooming
    const viewportMeta = document.createElement('meta');
    viewportMeta.name = 'viewport';
    viewportMeta.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
    document.head.appendChild(viewportMeta);
  </script>

  <style>
    /* Base styles */
    body {
      background: linear-gradient(135deg, #2193b0, #6dd5ed);
      font-family: 'Arial', sans-serif;
      color: #333;
      margin: 0;
      padding: 20px;
      transition: all 0.3s ease;
      min-height: 100vh;
    }

    /* Dark mode styles */
    body.dark-mode {
      background: linear-gradient(135deg, #121212, #1e1e1e);
      color: #f0f0f0;
    }

    body.dark-mode .box {
      background: #2d2d2d;
      color: #f0f0f0;
    }

    body.dark-mode input,
    body.dark-mode textarea,
    body.dark-mode button {
      background-color: #3d3d3d;
      color: #f0f0f0;
      border-color: #555;
    }

    body.dark-mode .upload-guidelines {
      background: linear-gradient(to right, #2d2d2d, #3d3d3d);
      color: #f0f0f0;
    }

    /* Responsive design */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .box {
        padding: 15px;
      }
      
      input, textarea, button {
        padding: 10px;
      }
    }

    /* Rest of your existing styles... */
    .dashboard {
      max-width: 900px;
      margin: auto;
    }
    .box {
      background: white;
      color: black;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .box:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    h2 { 
      color: #2193b0;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }
    input, textarea, button {
      width: 100%;
      margin-top: 10px;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      transition: all 0.3s;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: #2193b0;
      box-shadow: 0 0 5px rgba(33, 147, 176, 0.5);
    }
    button {
      background: #2193b0;
      color: white;
      cursor: pointer;
      transition: 0.3s;
      border: none;
      font-weight: bold;
    }
    button:hover {
      background: #6dd5ed;
      transform: scale(1.02);
    }
    .profile-img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 50%;
      margin-bottom: 15px;
      border: 3px solid #2193b0;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    ul { list-style-type: none; padding: 0; }
    .warning {
      background-color: red;
      color: white;
      padding: 10px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 20px;
      font-weight: bold;
      animation: blinkWarning 1s infinite alternate;
    }
    @keyframes blinkWarning {
      from { opacity: 0.8; }
      to { opacity: 1; }
    }
    .upload-guidelines {
      background:linear-gradient(to right, #e3f2fd, #bbdefb);
      padding:20px 25px;
      border-left:6px solid #1976d2;
      border-radius:12px;
      box-shadow:0 4px 8px rgba(0,0,0,0.1);
      margin-bottom:25px;
      font-family:sans-serif;
    }
    .upload-guidelines h2 {
      color:#0d47a1;
      margin-top:0;
      text-shadow: 1px 1px 1px rgba(0,0,0,0.1);
    }
    .upload-guidelines ul {
      padding-left:20px;
      margin:15px 0;
      line-height:1.8;
      color:#212121;
    }
    #notification-bell {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #ff5722;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: transform 0.3s;
    }
    #notification-bell:hover {
      transform: scale(1.1) rotate(15deg);
    }
    #notification-count {
      position: absolute;
      top: -5px;
      right: -5px;
      background: red;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .power-button {
      background: linear-gradient(to right, #ff416c, #ff4b2b);
      color: white;
      padding: 10px 15px;
      border-radius: 50px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 4px 15px rgba(255, 65, 108, 0.4);
      transition: all 0.3s;
    }
    .power-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 7px 20px rgba(255, 65, 108, 0.6);
    }
  </style>
</head>

<body>
  <!-- Your existing HTML content remains the same -->
  <div id="content" style="display:none;">
    <!-- ... rest of your HTML ... -->
  </div>
</body>
</html>



              
